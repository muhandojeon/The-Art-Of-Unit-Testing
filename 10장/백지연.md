# 10장 더 나은 테스트 전략 수립

## 일반적인 테스트 유형과 수준

테스트 수준이 높을수록 실제 의존성을 더 많이 사용하게 되어 전체 시스템 정확성에 대한 신뢰도는 높다.  
그러나 테스트는 더 느려지고 불안정해질 수 있는 단점이 있다.

### 단위 테스트와 컴포넌트 테스트

단위 테스트와 컴포넌트 테스트는 같은 범주에 속한다.  
두 테스트는 메모리에서 실행되는 단위 테스트로, 사용하는 모든 요소에 대한 제어권을 갖고 있다.  
파일, 데이터베이스, 네트워크, 환경 설정 등 직접 제어할 수 없는 외부 의존성은 없다고 가정한다.  
컴포넌트 테스트가 단위 테스트에 비해 더 많은 함수나 클래스, 컴포넌트를 작업 단위 내에 포함할 수 있다는 점에서 차이가 있다.  
즉, 컴포넌트 테스트는 진입점과 종료점 사이에 더 많은 요소를 포함한다.

### 통합 테스트

통합 테스트는 일반적인 단위 테스트와 거의 비슷하게 보이지만, 일부 의존성은 스텁을 대체할 수 없다.  
예를 들어 실제 환경 설정, 데이터베이스, 파일 시스템 등을 사용하는 경우다.

### API 테스트

API 테스트 단계에서는 애플리케이션을 최소한 일부라도 배포하고 네트워크를 통해 호출해야 한다.  
메모리 내부에서 하는 것이 아니라 작업 프로세스 외부에서 하는 테스트다.  
네트워크와 네트워크 서비스의 배포라는 새로운 의존성이 추가된다.

### E2E/UI 격리 테스트

E2E 테스트와 UI 테스트는 사용자 관점에서 애플리케이션을 테스트한다.  

'격리'라는 표현을 사용한 이유
- 테스트하는 애플리케이션이나 서비스만 대상으로 한다.
- 이 애플리케이션에 필요할 수 있는 외부 애플리케이션이나 서비스는 배포하지 않고 테스트한다는 의미를 명시하기 위해서다.

테스트 중인 애플리케이션에 속하지 않는 모든 코드를 가짜로 만들어 사용한다.

### E2E/UI 시스템 테스트

E2E/UI 시스템 테스트 단계에서는 가짜인 것이 없다.  
실제 운영 환경에 가장 가까운 상태에서 수행한다.

## 각 테스트 수준마다 존재하는 안티 패턴

### E2E 테스트만 사용하는 안티 패턴

이 수준의 테스트는 매우 느리고, 유지 보수하기 어렵고, 디버깅이 힘들며, 불안정성이 높다.  
이러한 비용은 계속 발생하는 반면, 새로운 E2E 테스트를 작성하는 것에서 얻는 가치는 점점 줄어든다.  
E2E 테스트는 효율성이 떨어지는 것도 문제지만, 불안정성이 높아 여러 이유로 실패하는 것도 문제다.  
조직 내에서는 실패 이유를 체계적으로 분석하고, 그 이유가 실제로 중요한 문제인지 아니면 사소한 오류인지 구분하는 역할이 필요하다.  
이 문제를 해결하는 방법은 탄탄하게 설계된 자동화 테스트 파이프라인을 구축하는 것이다.  
이렇게 하면 불안정한 테스트가 있더라도 빌드가 성공했는지 자동으로 판단할 수 있다.

E2E 테스트를 완전히 피하지는 말되, E2E 테스트 수를 최소화할 것을 강력히 추천한다.

### 저수준 테스트만 사용하는 안티 패턴

E2E 테스트만 사용하는 것과 반대되는 경우는 저수준 테스트만 사용하는 것이다.  
이 방식의 문제는 이러한 테스트가 통과되더라도 애플리케이션이 제대로 작동한다고 확신하기에는 신뢰도가 충분하지 않다는 것이다.  

### 저수준 테스트와 고수준 테스트의 단절

속도를 위해 저수준 테스트를, 신뢰를 위해 고수준 테스트를 함께 사용하면 이상적이다.  
테스트가 단절되어 있으면 예상치 못한 오류나 비효율성이 따라온다.  

## 테스트 레시피 전략

조직 내 테스트 유형 간 균형을 맞추기 위해 '테스트 레시피 전략'을 추천한다.  
테스트 레시피란 특정 기능을 어떻게 테스트할지 간단한 계획을 세우는 것이다.  
계획에는 happy path뿐만 아니라, edge case도 모두 포함해야 한다.  
잘 만든 테스트 레시피는 각 시나리오에 어떤 테스트 수준이 적합한지 판단하는 데 사용할 수 있다.

### 테스트 레시피 작성 방법

최소한 두 사람이 함께 작업하면 좋다.  
한 명은 개발자 관점에서, 다른 한 명은 테스터 관점에서 접근하는 것이 이상적이다.  

테스트 레시피를 작성하기에 가장 좋은 시점은 기능 작업을 시작하기 직전이다.  

테스트 레시피는 기능이 제대로 작동한다는 신뢰감을 주는 시나리오 목록을 의미한다.  
고수준 테스트와 저수준 테스트 간에는 1:5 또는 1:10 비율을 유지하면 좋다.  

예를 들어 사용자 프로필 기능에 대한 테스트 레시피는 다음과 같다.
```
- E2E : 로그인, 프로필 화면으로 이동, 이메일 업데이트, 로그아웃, 새 이메일로 다시 로그인, 프로필 화면 업데이트 확인
- API : 더 복잡한 데이터를 사용하여 UpdateProfile API 호출
- 단위 테스트 : 잘못된 이메일로 프로필 업데이트 로직 확인
- 단위 테스트 : 동일한 이메일로 프로필 업데이트 로직 확인
- 단위 테스트 : 프로필 데이터 변환 및 데이터 복원
```

## 배포 파이프라인 관리

테스트는 두 가지 그룹으로 나눌 수 있다.

1. **배포 중단 테스트**
- 변경 사항에 문제없는지 배포 전에 판단하는 테스트
- 단위 테스트, E2E 테스트, 시스템 테스트, 보안 테스트 등이 여기에 속한다.
- 테스트가 통과하면 변경 사항에 문제 없다는 의미고, 실패하면 코드 수정

2. **참고용 테스트**
- 주요 성과 지표(KPI)를 파악하고 지속적으로 모니터링하는 데 사용
- 코드를 분석하고 복잡도를 스캔
- 고부하 성능 테스트를 하거나 장시간 실행되는 비기능적 테스트 역시 여기에 포함된다.
- 결과가 단순히 성공이나 실패로 나뉘지 않는다.

### 배포 파이프라인 대 탐색 파이프라인

배포에 직접적인 영향을 미치는 테스트와 그렇지 않은 테스트를 구분하여 두 가지 파이프라인으로 운영해야 한다.

1. **배포 파이프라인**
- 배포를 결정하는 테스트에 사용
- 이 파이프라인이 통과하면 코드를 자동으로 프로덕션에 배포해도 된다는 확신을 가질 수 있어야 한다.
- 비교적 빠르게 실행 결과를 알려줄 수 있어야 한다.
- 목적 : 코드가 문제없이 통과될 경우 배포를 진행하는 것

2. **참고용 테스트**
- 참고용 테스트에 사용
- 배포 파이프라인과 병렬로 실행되지만 지속적으로 작동하며 배포 기준에는 포함되지 않는다.
- 실행 결과를 기다릴 필요가 없기 때문에 테스트가 오래 걸려도 무방하다.
- 목적 : 리팩터링해야 하는 코드가 어디인지 찾기

### 테스트 계층 병렬화

테스트 결과를 신속하게 얻는 것이 중요하기 때문에 파이프라인의 각 단계별 결과를 빠르게 받기 위해 여러 테스트 계층을 병렬로 실행한다.
