# 더 나은 테스트 전략 수립

## 일반적인 테스트 유형과 수준

### 단위 테스트와 컴포넌트 테스트

* 테스트가 단위 테스트나 컴포넌트 테스트에 속하는지 여부는 **사용된 추상화 수준이 아니라, 외부 의존성이 있는지에 따라 결정된다**

### 통합 테스트

* 불안정성이 단위 테스트에 비해 높지만 그만큼 신뢰도가 높음
  + 실제 의존성 수에 따라 불안정성이 달라지고
  + 데이터베이스나 설정 파일처럼 우리가 제어할 수 없는 요소를 사용하는 코드가 제대로 동작하는 것을 확인할 수 있어 더 큰 신뢰감을 줆

### E2E/UI 격리 테스트 

* 격리라는 표현을 사용한 이유는 우리가 테스트하는 애플리케이션이나 서비스만 대상으로 하고 이 애플리케이션에 필요할 수 있는 외부 애플리케이션이나 서비스는 배포하지 않고 테스트한다는 의미를 명시하기 위해서이다

> ex. Playwright/Cypress + MSW

### E2E/UI 시스템 테스트

* 가짜인 것이 없는 진짜 엔드 투 엔드

> https://www.hyesungoh.xyz/is-api-mocking-need-for-e2e-test
> 격리와 시스템 E2E 테스트에 쓴 ... 2년 전의 글
>
> > https://sorry-cypress.dev/ 
> > 이런 것도 있어여

## 각 테스트 수준마다 존재하는 안티 패턴

### E2E 테스트만 사용하는 안티 패턴

* 빌드 분석자
  + 고수준 테스트는 불안정성이 높아 여러 이유로 실패할 수 있는데 그중 일부는 실제 테스트와 관련 없는 이유때문
  + 겉으로는 실패한 것처럼 보이지만 실제로는 문제 없습니다 < 라고 말하는 사람들
  
* 빌드 분석의 고충을 해결하는 방법
  + 넷플릭스는 실제 환경에서 빌드가 어떻게 작동하는지 통계적으로 측정하여 자동으로 배포 승인을 할 수 있는 자체 도구를 개발했다고 함

> 여러 이유에서 실패할 수 있겠지만 .. 필요한 과정이지 않을까 싶기도 하네요

> https://netflixtechblog.com/automated-canary-analysis-at-netflix-with-kayenta-3260bc7acc69

```
넷플릭스 기술 블로그의 이 글은 Kayenta라는 자동 카나리아 분석(Automated Canary Analysis, ACA) 플랫폼에 대해 소개하고 있습니다. 주요 내용은 다음과 같습니다:

✅ Kayenta란?
 • Google과 협력하여 오픈소스로 공개된 자동 카나리아 분석 도구
 • Spinnaker(넷플릭스의 지속적 배포 플랫폼)와 통합되어 사용됨
 • 배포 시 **새로운 버전(카나리아)**과 **기존 버전(베이스라인)**의 성능을 비교하여 문제가 있는지 자동으로 판단

✅ 카나리아 배포란?
 • 새 버전을 전체에 배포하기 전에 일부 사용자에게만 배포하여 문제를 조기에 발견하는 방식
 • 넷플릭스는 3개의 클러스터를 사용:
 ▫ Production: 현재 운영 중인 버전
 ▫ Baseline: Production과 동일한 버전
 ▫ Canary: 새로 배포할 버전

✅ Kayenta의 분석 과정
 1. Metric Retrieval (지표 수집)
 ▫ Prometheus, Stackdriver, Datadog, Netflix Atlas 등 다양한 소스에서 지표 수집
 2. Judgment (판단 단계)
 ▫ 데이터 검증: 지표가 제대로 수집되었는지 확인
 ▫ 데이터 정제: 누락된 값 처리
 ▫ 지표 비교: Mann-Whitney U 테스트로 통계적 차이 분석
 ▫ 점수 계산: 전체 지표 중 “Pass” 비율로 최종 점수 산출

✅ 장점 및 성과
 • 사람이 직접 로그와 그래프를 비교하던 수작업을 자동화
 • 하루 평균 200건의 카나리아 분석 수행
 • 기존 시스템보다 설정이 간단하고 유연성 높음
 • 지표, 판단 알고리즘, 저장소 등을 플러그인 방식으로 확장 가능

✅ 기타
 • Kayenta는 Spinnaker 없이도 Redis만 있으면 독립 실행 가능
 • 분석 결과는 UI로 시각화되어 개발자가 쉽게 판단 가능
 • GitHub에서 Kayenta 오픈소스 확인 가능: https://github.com/spinnaker/kayenta ↗
```

* 그럼 E2E 테스트는 하지 말아야 할까?
  + E2E 테스트는 큰 안도감을 주기 때문에 와전히 피하지는 말되, 테스트 수를 최소화할 것을 강력히 추천함

## 테스트 레시피 전략

* 테스트 레시피는 5~20줄 정도로 구성된 간단한 텍스트 형식의 목록으로, 어떤 시나리오가 어떤 수준에서 자동화되어 테스트되어야 하는지 정리한 것이다. 이 레시피 목록에 있는 모든 테스트가 통과하면 해당 기능이 제대로 작동하고 있단느 확신을 얻을 수 있어야 한다.

* 테스트 레시피를 작성하기에 가장 좋은 시점은 기능 작업을 시작하기 전
* 테스트 레시피가 해당 기능의 '완료' 기준에 포함되기 때문에

* 일반적으로 저수준 테스트와 고수준 테스트 간에는 1:5 또는 1:10 비율을 유지하면 좋다
  + 예를 들어 고수준 테스트를 하나 작성하면 저수준 테스트는 다섯 개 정도 작성하는 식

## 테스트 레시피 작성 규칙

* 속도: 어떤 기능이 제대로 동작하는지에 대한 신뢰도를 얻는 방법이 E2E 밖에 없다면 어쩔 수 없지만, 그것이 아니라면 저수준 테스트를 우선시
* 신뢰도: 모든 테스트가 통과되었을 때 '이 기능은 잘 동작한다고 확신'한다면 레시피는 완성된 것이다. 그것이 아니라면 그런 확신을 줄 수 있는 테스트 시나리오를 더 만들어야 한다.
* 수정
* 적절한 타이밍
* 페어 프로그래밍
* 기존 기능의 테스트를 중복하지 말 것
* 다른 계층에서 테스트를 중복해서 작성하지 말 것
* 더 많이, 더 빠르게
* 실용성 중시: 모든 기능을 모든 수준으로 작성하지 ㅁ라자. 제대로 작동한다고 느낄수 있을 만큼만 작성하자

## 배포 파이프라인 관리

* 배포에 직접적인 영향을 미치는 테스트와 그렇지 않은 테스트를 구분하여 두 가지 파이프라인으로 운영하자
  + 시간이 많이 소요되므로 테스트 결과를 받는 데 상당한 시간이 걸림
  + 테스트 실패가 발생하더라도 실제로는 배포를 중단해야 할 중요한 문제가 아닐 떄도 많음
  + 그럼에도 테스트 결과가 실패로 표시되면 배포가 지연되고 작업 흐름이 끊길 수 있음

* 배포 파이프라인
  + 빌드, 단위 테스트, E2E 테스트, 보안 테스트

* 탐색 파이프라인
  + 린트, 코드 품질, 성능, 부하

## 요약

* 각 테스트는 복잡성, 불안정성, 테스트를 통과할 때 신뢰도, 유지 보수성, 실행 속도라는 다섯 가지 기준으로 평가할 수 있다.

* 가장 중요한 기능만 확인하는 용도로 소수의 E2E 테스트를 사용하는 것이 가장 효율적이다.
