## 3장 의존성 분리와 스텁

### 의존성 유형

- 외부로 나가는 의존성
  - 로거 함수 호출
  - 데이터베이스에 저장
  - 이메일 발송
  - API나 웹훅에 알림 보내기
- 내부로 들어오는 의존성
  - 데이터베이스 쿼리 결과
  - 네트워크 응답 결과
 
#### 스텁과 목

스텁과 목은 큰 차이가 있으니 올바른 용어를 사용하여 상대방이 무엇을 의미하는지 명확히 하는 것이 중요    
헷갈릴 때는 '테스트 더블' 또는 '페이크' 라는 용어를 사용하자

- 스텁: 고객이 해리포터 책 검색할 때 실제 DB에 접근하지 않고도 결과를 반환하도록 하기 위해 스텁 사용 가능 ([spyOn](https://vitest.dev/api/vi.html#vi-spyon))
  - 테스트 독립성 높여 주지만, 호출여부는 검증하지 않음 
- 목: 외부 시스템과 상호 작용을 시뮬레이션하고, 호출 여부나 호출된 인수를 검증하는 데 사용
  - 고객이 해리포터 책을 검색하고 장바구니에 추가할 때, 실제로 DB에 책이 추가되지 않더라도 책 추가 함수가 제대로 호출되었는지([tohavebeencalled](https://vitest.dev/api/expect#tohavebeencalled)), 어떤 인수로 호출되었는지 ([tohavebeencalledwith](https://vitest.dev/api/expect#tohavebeencalledwith)) 등을 확인하는 데 목을 사용함
  - 또 주문 확인 이메일을 보내는 기능을 테스트할 때, 실제로 이메일을 보내지 않으면서 이메일 발송 함수가 호출되었는지 등을 확인할 수 있음
  - 목은 하나의 테스트에서 하나만 사용하는 것이 좋음
- 페이크: 실제 구현을 대체하는 가벼운 버전의 구성요소
  - 예를 들어 실제 운영 DB 대신 인메모리 DB 사용하여 테스트 수행하기
 
### 스텁을 왜 사용해야 할까?
> 일관성 있는 테스트를 보장하기 위해

### 스텁을 사용하는 일반적인 설계 방식
작업 단위에 스텁을 어떻게 주입할수 있을까?

## 스텁으로 만든 시간을 매개변수로 주입
SOLID 원칙중에 DIP(의존성 역전 원칙) 의 한 형태임
> 고수준의 모듈에서 저수준의 모듈을 직접 참조하지 마라. next/link를 컴포넌트에서 직접 참조하는게 아닌 추상화된 레이어(e.g CustomLink)를 두고 참조해라. 그럼 한번에 수정하기도 쉬운 장점이 있음

의존성 주입해라


## 함수를 이용한 주입 방법

> 함수를 매개변수로 전달하는게 가능하고, 이렇게 하면 특정 상황에 예외를 만들어 내거나 테스트 내에서 특정한 동작을 하도록 만들 수 있어 유용하게 사용될 수 있다는데 아직 잘 모르겠다.....(진짜 모름)

## 모듈을 이용한 주입 방법

외부와 연결된 직접적인 의존성을 다른것으로 대체할 수 있는 심 이라는 것을 만들면 된다.

### 이것이 심

![스크린샷 2025-02-25 오전 1 10 20](https://github.com/user-attachments/assets/6695d9d7-d2b0-45ba-ab7a-e32f745be36c)

### 이건 테스트 코드에서 inject()와 reset() 함수 사용한거

![스크린샷 2025-02-25 오전 1 12 53](https://github.com/user-attachments/assets/59491751-b9d1-463d-81c5-cb90afdf3607)
![스크린샷 2025-02-25 오전 1 13 00](https://github.com/user-attachments/assets/8a60942d-efe1-4b2f-af03-e5990db1f945)

1. injectDate() 함수는 테스트에서 반복되는 코드를 줄이는 헬퍼 함수, 이 함수는 moment.js 모듈을 가짜 객체로 만들어 moment().day() 함수가 () => newDay로 대체되도록 함
2. injectDate() 함수는 내부에서 가짜로 만든 moment.js 모듈을 인수로 전달하며 inject() 함수를 호출한다. 매개변수로 newDay를 받아 가짜 의존성을 만드는데, 이렇게 만든 가짜 의존성을 모듈에 적용함
3. 테스트에서 가짜 날짜를 인수로 넘기면서 injectDate를 호출하여 의존성을 대체함
4. 테스트가 끝나면 reset() 함수를 호출하여 작업 단위 내에 있는 모듈 의존성을 원래 상태로 되돌림

- 장점: 의존성 문제 확실히 해결해주고 사용하기 쉽다
- 단점: 의존성의 API에 매우 강하게 묶임

