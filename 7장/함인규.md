## 개요 :: 테스트의 신뢰성.

테스트의 “신뢰성”이 떨어지면 테스트의 가치는 떨어진다.

테스트 결과를 믿지 않으면 뭐하러 테스트 코드를 짜냐 이말이지.

테스트의 신뢰성이 떨어지는 경우를 크게 세가지로 나누면 다음과 같다.

1. 테스트 통과에 실패했는데, 실패한 이유를 납득할 수 없어.
2. 테스트를 통과했는데, 통과 결과를 믿을 수 없어.
3. 테스트가 불안정해.. 언제는 성공하고 언제는 실패해.

## 테스트 통과에 실패하는 경우

테스트가 실패했을 때, 실제 프로덕션 코드에서도 버그가 발생한다면 우리는 실패 결과를 믿을 수 있다.

하지만 그 외에도 실패할 수 있는 상황이 많은데, 이제부터 소개하는 상황들은 납득할 수 없는(신뢰할 수 없는) 실패 상황이다.

1. 기능 변경으로 인해 테스트가 최신 상태가 아닌 경우
    - 테스트 유지보수 평소에 좀 잘하자.
2. 테스트가 다른 테스트와 충돌하는 경우
    - 두 테스트가 서로 상충되는 기대치를 가지고 있어 동시에 성공할 수 없는 경우
    - 이런 상황에는 더 적합한 것을 고르고 나머지 하나를 버리면 된다.
3. 테스트가 거짓 양성(거짓 실패)을 일으키는 경우
    - 프로덕션 코드엔 문제가 없는데 테스트 코드 자체에 문제가 있는 경우
    - 테스트 코드의 버그를 고치자..! → 고쳐서 통과했다 하더라도 실패값을 넣어서 실패 검증 상황도 테스트 해봐야한다.

## 테스트 통과에 실패하는 경우 - 거짓 양성(거짓 실패)을 일으키는 경우

테스트 코드에 로직을 많이 넣을 수록 테스트에 버그가 생길 확률이 기하급수적으로 증가한다. → 거짓 양성(거짓 실패)을 일으킨다.

이 상황을 피하기 위해서 다음과 같은 것들을 주의하자.

1. 검증 단계에서 기댓값을 동적으로 생성하지 말자.
    - 가능하면 하드코딩된 값을 사용하기
2. 테스트 코드 내에서 반복문 / 조건문을 사용하지 말자.
    - 반복문 / 조건문을 사용하면 입력값을 동적으로 생성하게 된다.
    - 입력값을 동적으로 생성하게 되면 기대값도 동적으로 생성해야한다.
    - (1)에서 기댓값을 동적으로 생성하지 말자고 했다.

이렇게 테스트 코드에 넣지 말라는 로직을 넣었을 때의 문제가 무엇이냐하면..

- 프로덕션 코드의 로직을 테스트 코드에서도 갖게된다.
    
    → 입력값이 변함에 따라 기댓값도 바뀜.. → 프로덕션 코드의 결과 도출 로직이 기댓값 생성 로직에도 쓰임..!
    
- 프로덕션 코드에 버그가 있을 때 테스트 코드도 동일한 버그를 포함하게 되어 테스트가 버그를 제대로 잡아내지 못할 수 있다.

## 테스트 통과했다 하더라도 안심할 수 있을까?

**“잘못된 신뢰”** : 신뢰하지 말아야 할 테스트를 신뢰하지만, 그 사실을 아직 모르는 상태.

테스틀를 통과했지만 그 테스트를 믿지 못하는 경우들은 다음과 같다.

1. 검증 부분이 없는 경우
    - 무엇이 참인지 거짓인지 확인하지 않음.
2. 테스트를 이해할 수 없는 경우 ( 가독성 떨어짐 )
    - 테스트 이름이 적절하지 않거나
    - 테스트 코드가 너무 길고 복잡하거나
    - 변수 이름이 헷갈리거나
    - 숨어있는 로직이나 이해하기 어려운 가정을 포함했거나
    - 결과가 불분명한(실패도 아니고 통과도 아닌) 테스트거나
    - 테스트 메시지가 충분한 정보를 제공하지 않는다거나
3. 테스트가 여러 가지를 한꺼번에 검증하는 경우
    - 종료점이 여러개인 작업 단위를 테스트할 때, 하나의 테스트에서 여러 검증을 한꺼번에 진행하지 말자.
    - 테스트 이름을 짓기도 애매할 뿐더러, 테스트 검증 메서드(expect)는 예외가 발생한 줄에서 바로 종료되기 때문에 다른 종료점 검증 실패를 놓칠 수 있다.
4. 테스트가 자주 변경되는 경우
    - 현재 날짜/시간 등(ex. 난수..)을 사용하여 매번 실행할 때마다 다른 테스트가 되는 경우.
5. 단위 테스트가 불안정한 테스트와 섞여있는 경우

## 불안정한 테스트(통합 테스트)

“불안정한 테스트” : 코드에 아무런 변화가 없는데도 일관성 없는 결과를 반환하는 테스트

제어할 수 없는 의존성을 가지면 가질 수록 불안정한 테스트라 볼 수 있다.

불안정한 테스트를 발견했을 때의 대응 방법

1. 불안정하다고 판단한 테스트를 별도의 카테고리나 폴더에 따로 격리하여 별도로 실행할 수 있도록 한다  ( 안정적인 테스트 영역 만들기 )
    - 통합 테스트 영역과 단위 테스트 영역을 분리하는 작업이다.
2. 불안정한 테스트를 격리했다면, 그 테스트들을 하나씩 검토하며 수정, 리팩터링, 삭제 과정을 밟아본다.
    - 수정 : 의존성을 직접 제어하여 테스트 안정성을 높여본다. ( 실제 의존성 건드리기 )
    - 리팩터링 : 의존성을 제거하거나 제어(가짜로 대체 - 스텁, 목 활용)하여 불안정성 제거하기
    - 삭제 : 이 테스트로 얻는 이점이 없을 것 같다고 판단되면 지워버리는 것도 방법이다!
