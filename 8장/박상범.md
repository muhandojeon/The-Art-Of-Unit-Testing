# 8장 유지보수성

이 장에서는 테스트를 점검할 때 유지보수성을 높이는 데 사용할 수 있는 일련의 방법들을 소개함

유지보수성이 테스트를 얼마나 자주 변경해야 하는지 가늠하는 척도라면 그 횟수를 최소화하는 것이 중요

이를 위한 근본적인 원인을 파악하려면 아래 항목 점검이 필요하다 함

- 언제 테스트가 실패하여 변경이 필요하다는 사실을 깨닫는가
- 왜 테스트가 실패하는가
- 어떤 테스트가 실패했을 때 테스트 코드를 반드시 수정해야 하는가
- 테스트 코드를 반드시 수정할 필요가 없더라도 언제 코드를 변경하는가

## 테스트 실패로 코드 변경

- 실제 실패: 실제 버그로 발생한 실패
- 거짓 실패: 프로덕션 코드의 버그가 아닌 다른 이유로 발생한 실패

테스트의 유지보수성을 측정하려면 일정 기간동안 발생하는 거짓 실패 횟수와 그 원인을 분석해야 됨

### 1. 프로덕션 코드의 API 변경
테스트 대상 코드가 변경되어 함수나 객체 사용 방식이 달라지면 테스트 실패할 수 있음

#### 팩토리 함수로 객체를 만드는 과정을 분리해야 한다

유지보수성을 떨어뜨릴 수 있는 잠재적인 문제 상황을 피하는 방법은 테스트할 코드의 생성 과정을 분리하거나 추상화 하는 것   
=> 이렇게 하면 생성자 변경 사항을 중앙에서만 처리 가능
=> 나중에 변경사항 발생해도 팩토리 함수만 수정하면 되니까 대부분 테스트는 수정할 필요 없어짐

### 2. 다른 테스트가 변경되었을 경우

테스트가 제대로 분리되지 않으면 각 테스트가 서로 간섭하게 돼서 나중에 원인찾는게 어려움

### 순서가 정해진 테스트

이전 테스트의 실행 여부에 따라 결과가 달라지는 상황
=> 왜? 다른 테스트 때문에 설정 값이 바뀌거나 공유 변수같은 자원 상태값이 변경되는 것에 영향 받아서
=> 그리고 테스트 러너도 항상 특정 순서로 실행하지 않는다는 점도 명심해야됨

책에서 나온 예제는 1,3번째 테스트가 2번째 테스트에 의존하고 있음
> https://github.com/gilbutITbook/080410/blob/master/ch8-maintain/specialApp.spec.ts

유저를 추가하는 헬퍼함수 만들고, 각 테스트에서 이 헬퍼함수를 사용하고 테스트 사이에 유저 캐시를 초기화 하는 방향으로 리팩토링 하면 실행 순서에 대한 의존성 삭제 가능
> https://github.com/gilbutITbook/080410/blob/master/ch8-maintain/specialApp.v2.spec.ts


## 테스트가 실패하지 않더라도 견고함을 위해 유지보수성을 보장할 수 있는 리팩터링 방법

### private 또는 protected 메서드 사용하지 않기

private 메서드는 홀로 존재하지 않음. 보통 public 메서드가 호출하고 그렇지 않더라도 실행 연결 고리중에 public 메서드가 연결되어 있음

그니까 public 메서드로 private 메서드 간접적으로 테스트하는 것이 효과적임 

중요한건 시스템의 외부 동작, 즉 public 메서드가 올바르게 작동하는지 확인하는 것임


### 테스트에서도 DRY 원칙 고수

헬퍼 함수 사용하면 테스트 중복 부분 줄일 수 있는데, 형태가 비슷해 보인다고 다 헬퍼 함수로 묶는 행동은 하지말자. 오히려 가독성 떨어뜨릴 수 있으니 적절하게.

### 초기화 함수 사용하지 않기

대신에 팩토리 함수, 헬퍼 함수 적극적으로 사용하자

### 매개변수화된 테스트로 중복 코드 제거

test.each(), it.each() 로 리팩토링 가능

## 과잉 명세된 테스트

과잉 명세: 단순히 코드의 외부 동작을 확인하는 것이 아니라, 코드 내부가 어떻게 구현되어야 하는지 까지 검증하는 테스트를 의미

예시로는 메서드의 내부 로직이나 특정 상태 변화를 검증하는 테스트가 이에 해당하는데, 테스트가 지나치게 구체적이고 복잡해서 나중에 코드 변경하면 테스트를 자주 수정해야 된다는 문제가 발생함

### 목을 사용한 내부 동작 과잉 명세

종료점이 아닌 protected 메서드를 모의 함수로 만들어 검증하고 있는데 이건 결합도만 올리는 행위임
> https://github.com/gilbutITbook/080410/blob/master/ch8-maintain/00-password-verifier.v4.spec.ts

passwordVerifier 클래스
> https://github.com/gilbutITbook/080410/blob/master/ch8-maintain/00-password-verifier.v4.ts

#### 그럼 어케함?

값 기반 테스트가 필자가 추천하는 방법임.

passwordVerifier4 클래스에서 verify() 메서드가 값을 반환하니까 pv4.verify("abc") 하면 됨

### 결과와 순서를 지나치게 세밀하게 검증

첫번째 두번째 테스트처럼 하면 순서와 구조에 의존하니까 세번째 테스트코드처럼 순서와 구조를 무시하고 테스트 할 수 있도록 작성해라
> https://github.com/gilbutITbook/080410/blob/master/ch8-maintain/00-password-verifier.v5.spec.ts

메시지 검증할 때에는 중요한 내용만 검증해라
> https://github.com/gilbutITbook/080410/blob/master/ch8-maintain/00-password-verifier.v6.spec.ts

